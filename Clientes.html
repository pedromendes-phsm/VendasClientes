<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VendaF√°cil</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    #loginScreen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    .login-box {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    }

    .login-box h1 { font-size: 1.8rem; margin-bottom: 6px; color: #f8fafc; }
    .login-box p { color: #94a3b8; margin-bottom: 28px; font-size: 0.9rem; }

    .tab-btns { display: flex; gap: 8px; margin-bottom: 24px; }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid #334155;
      background: transparent;
      color: #94a3b8;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .tab-btn.active { background: #3b82f6; border-color: #3b82f6; color: #fff; }

    .form-group { margin-bottom: 16px; }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 14px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus { outline: none; border-color: #3b82f6; }

    .btn-primary {
      width: 100%;
      padding: 13px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary:hover { background: #2563eb; }
    .btn-primary:disabled { background: #334155; cursor: not-allowed; }

    .error-msg { color: #f87171; font-size: 0.85rem; margin-top: 10px; text-align: center; }

    #adminPanel, #clientPanel { display: none; }

    .topbar {
      background: #1e293b;
      border-bottom: 1px solid #334155;
      padding: 14px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .topbar h2 { font-size: 1.1rem; color: #f8fafc; }
    .topbar span { color: #94a3b8; font-size: 0.85rem; }

    .btn-logout {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #94a3b8;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .btn-logout:hover { border-color: #f87171; color: #f87171; }

    .container { padding: 28px; max-width: 1200px; margin: 0 auto; }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }

    .card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 20px;
    }

    .card .label { font-size: 0.8rem; color: #94a3b8; margin-bottom: 6px; }
    .card .value { font-size: 1.6rem; font-weight: 700; }
    .card.green .value { color: #4ade80; }
    .card.yellow .value { color: #facc15; }
    .card.red .value { color: #f87171; }
    .card.blue .value { color: #60a5fa; }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #334155;
    }

    .sale-form {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 28px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    .btn-add {
      padding: 11px 24px;
      background: #22c55e;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-add:hover { background: #16a34a; }
    .btn-add:disabled { background: #334155; cursor: not-allowed; }

    .filters { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }

    .filters input,
    .filters select {
      padding: 9px 13px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 0.88rem;
    }

    .filters input:focus,
    .filters select:focus { outline: none; border-color: #3b82f6; }

    .table-wrap {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; }
    thead { background: #0f172a; }

    th {
      padding: 13px 16px;
      text-align: left;
      font-size: 0.8rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: 13px 16px;
      font-size: 0.9rem;
      border-top: 1px solid #334155;
      color: #cbd5e1;
    }

    tr:hover td { background: #263248; }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.78rem;
      font-weight: 600;
    }

    .badge.pago { background: #14532d; color: #4ade80; }
    .badge.pendente { background: #713f12; color: #facc15; }
    .badge.vencido { background: #7f1d1d; color: #f87171; }
    .badge.cancelado { background: #1e293b; color: #94a3b8; border: 1px solid #475569; }

    .btn-action {
      padding: 5px 11px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      margin-right: 4px;
      transition: opacity 0.2s;
    }

    .btn-action:hover { opacity: 0.8; }
    .btn-edit { background: #1d4ed8; color: #fff; }
    .btn-delete { background: #991b1b; color: #fff; }

    .empty-state { text-align: center; padding: 48px; color: #475569; }

    .client-header {
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
      border-bottom: 1px solid #334155;
      padding: 20px 28px;
    }

    .client-header h2 { font-size: 1.3rem; color: #f8fafc; }
    .client-header p { color: #94a3b8; font-size: 0.85rem; margin-top: 2px; }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 14px;
      padding: 28px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.6);
    }

    .modal h3 { font-size: 1.1rem; margin-bottom: 20px; color: #f8fafc; }

    .modal-btns { display: flex; gap: 10px; margin-top: 20px; }

    .btn-cancel {
      flex: 1;
      padding: 11px;
      background: transparent;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #94a3b8;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-save {
      flex: 1;
      padding: 11px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff44;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 14px 20px;
      font-size: 0.9rem;
      color: #f1f5f9;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      z-index: 9999;
      transform: translateY(80px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-left: 4px solid #4ade80; }
    .toast.error { border-left: 4px solid #f87171; }

    @media (max-width: 600px) {
      .container { padding: 16px; }
      .form-grid { grid-template-columns: 1fr; }
      .filters { flex-direction: column; }
      th, td { padding: 10px 12px; font-size: 0.82rem; }
    }
  </style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <h1>üì¶ VendaF√°cil</h1>
    <p>Sistema de gest√£o de vendas</p>

    <div class="tab-btns">
      <button class="tab-btn active" onclick="switchTab('admin')">Administrador</button>
      <button class="tab-btn" onclick="switchTab('client')">Cliente</button>
    </div>

    <div id="adminLogin">
      <div class="form-group">
        <label>Usu√°rio</label>
        <input type="text" id="adminUser" placeholder="admin" />
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button class="btn-primary" id="btnLoginAdmin" onclick="loginAdmin()">Entrar como Admin</button>
      <p class="error-msg" id="adminError"></p>
    </div>

    <div id="clientLogin" style="display:none">
      <div class="form-group">
        <label>Seu CPF ou E-mail cadastrado</label>
        <input type="text" id="clientId" placeholder="Ex: 123.456.789-00" />
      </div>
      <button class="btn-primary" id="btnLoginClient" onclick="loginClient()">Consultar Minhas Compras</button>
      <p class="error-msg" id="clientError"></p>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPanel">
  <div class="topbar">
    <div>
      <h2>üì¶ VendaF√°cil ‚Äî Painel Admin</h2>
      <span>Gerencie todas as vendas</span>
    </div>
    <button class="btn-logout" onclick="logout()">Sair</button>
  </div>

  <div class="container">
    <div class="summary-cards" id="adminCards"></div>

    <div class="sale-form">
      <div class="section-title">‚ûï Registrar Nova Venda</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Cliente (Nome)</label>
          <input type="text" id="fCliente" placeholder="Nome do cliente" />
        </div>
        <div class="form-group">
          <label>CPF / E-mail do Cliente</label>
          <input type="text" id="fClienteId" placeholder="Para acesso do cliente" />
        </div>
        <div class="form-group">
          <label>Produto / Servi√ßo</label>
          <input type="text" id="fProduto" placeholder="Descri√ß√£o do produto" />
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" id="fValor" placeholder="0,00" step="0.01" min="0" />
        </div>
        <div class="form-group">
          <label>Vencimento</label>
          <input type="date" id="fVencimento" />
        </div>
        <div class="form-group">
          <label>Situa√ß√£o</label>
          <select id="fSituacao">
            <option value="pendente">Pendente</option>
            <option value="pago">Pago</option>
            <option value="vencido">Vencido</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
      </div>
      <button class="btn-add" id="btnAdd" onclick="addSale()">‚úî Registrar Venda</button>
    </div>

    <div class="filters">
      <input type="text" id="filterSearch" placeholder="üîç Buscar cliente ou produto..."
             oninput="renderTable()" style="flex:1; min-width:200px" />
      <select id="filterStatus" onchange="renderTable()">
        <option value="">Todas as situa√ß√µes</option>
        <option value="pendente">Pendente</option>
        <option value="pago">Pago</option>
        <option value="vencido">Vencido</option>
        <option value="cancelado">Cancelado</option>
      </select>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Produto / Servi√ßo</th>
            <th>Valor</th>
            <th>Vencimento</th>
            <th>Situa√ß√£o</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="salesTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- CLIENTE -->
<div id="clientPanel">
  <div class="client-header">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <h2 id="clientWelcome">Ol√°, Cliente!</h2>
        <p>Acompanhe suas compras e valores a pagar</p>
      </div>
      <button class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="container">
    <div class="summary-cards" id="clientCards"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Produto / Servi√ßo</th>
            <th>Valor</th>
            <th>Vencimento</th>
            <th>Situa√ß√£o</th>
          </tr>
        </thead>
        <tbody id="clientTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL EDITAR -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h3>‚úèÔ∏è Editar Venda</h3>
    <input type="hidden" id="editDocId" />
    <div class="form-grid" style="grid-template-columns:1fr 1fr">
      <div class="form-group">
        <label>Cliente</label>
        <input type="text" id="editCliente" />
      </div>
      <div class="form-group">
        <label>CPF / E-mail</label>
        <input type="text" id="editClienteId" />
      </div>
      <div class="form-group">
        <label>Produto / Servi√ßo</label>
        <input type="text" id="editProduto" />
      </div>
      <div class="form-group">
        <label>Valor (R$)</label>
        <input type="number" id="editValor" step="0.01" min="0" />
      </div>
      <div class="form-group">
        <label>Vencimento</label>
        <input type="date" id="editVencimento" />
      </div>
      <div class="form-group">
        <label>Situa√ß√£o</label>
        <select id="editSituacao">
          <option value="pendente">Pendente</option>
          <option value="pago">Pago</option>
          <option value="vencido">Vencido</option>
          <option value="cancelado">Cancelado</option>
        </select>
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-save" id="btnSaveEdit" onclick="saveEdit()">Salvar Altera√ß√µes</button>
    </div>
  </div>
</div>

<!-- FIREBASE SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs,
    doc, updateDoc, deleteDoc, query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üî• SUBSTITUA AQUI PELAS SUAS CREDENCIAIS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_PROJETO.firebaseapp.com",
    projectId: "SEU_PROJETO_ID",
    storageBucket: "SEU_PROJETO.appspot.com",
    messagingSenderId: "SEU_SENDER_ID",
    appId: "SEU_APP_ID"
  };
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ‚îÄ‚îÄ CREDENCIAIS ADMIN (altere se quiser) ‚îÄ‚îÄ
  const ADMIN_USER = 'admin';
  const ADMIN_PASS = '1234';

  let sales = [];
  let currentTab = 'admin';
  let currentClientId = null;
  let unsubscribe = null;

  // ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
  function fmt(val) {
    return parseFloat(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function fmtDate(d) {
    if (!d) return '‚Äî';
    const [y, m, day] = d.split('-');
    return `${day}/${m}/${y}`;
  }

  function badgeHTML(s) {
    const map = { pago: 'Pago', pendente: 'Pendente', vencido: 'Vencido', cancelado: 'Cancelado' };
    return `<span class="badge ${s}">${map[s] || s}</span>`;
  }

  function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  function setLoading(btnId, loading, label) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    btn.disabled = loading;
    btn.innerHTML = loading ? `<span class="loading"></span> Aguarde...` : label;
  }

  // ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
  window.switchTab = function(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach((b, i) => {
      b.classList.toggle('active', (i === 0 && tab === 'admin') || (i === 1 && tab === 'client'));
    });
    document.getElementById('adminLogin').style.display  = tab === 'admin'  ? 'block' : 'none';
    document.getElementById('clientLogin').style.display = tab === 'client' ? 'block' : 'none';
  };

  // ‚îÄ‚îÄ LOGIN ADMIN ‚îÄ‚îÄ
  window.loginAdmin = function() {
    const u = document.getElementById('adminUser').value.trim();
    const p = document.getElementById('adminPass').value;
    if (u === ADMIN_USER && p === ADMIN_PASS) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminPanel').style.display  = 'block';
      startRealtimeListener();
    } else {
      document.getElementById('adminError').textContent = 'Usu√°rio ou senha incorretos.';
    }
  };

  // ‚îÄ‚îÄ LOGIN CLIENTE ‚îÄ‚îÄ
  window.loginClient = async function() {
    const id = document.getElementById('clientId').value.trim().toLowerCase();
    if (!id) { document.getElementById('clientError').textContent = 'Informe seu CPF ou e-mail.'; return; }

    setLoading('btnLoginClient', true, 'Consultar Minhas Compras');

    try {
      const snap = await getDocs(collection(db, 'vendas'));
      const all  = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
      const mine = all.filter(s => s.clienteId.toLowerCase() === id);

      if (mine.length === 0) {
        document.getElementById('clientError').textContent = 'Nenhuma compra encontrada para este CPF/e-mail.';
        setLoading('btnLoginClient', false, 'Consultar Minhas Compras');
        return;
      }

      currentClientId = id;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('clientPanel').style.display = 'block';
      document.getElementById('clientWelcome').textContent = `Ol√°, ${mine[0].cliente}!`;
      renderClientPanel(mine);
    } catch (e) {
      document.getElementById('clientError').textContent = 'Erro ao conectar. Tente novamente.';
    }

    setLoading('btnLoginClient', false, 'Consultar Minhas Compras');
  };

  // ‚îÄ‚îÄ LISTENER TEMPO REAL (ADMIN) ‚îÄ‚îÄ
  function startRealtimeListener() {
    if (unsubscribe) unsubscribe();
    const q = query(collection(db, 'vendas'), orderBy('vencimento', 'asc'));
    unsubscribe = onSnapshot(q, (snap) => {
      sales = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
      renderTable();
      renderAdminCards();
    });
  }

  // ‚îÄ‚îÄ ADICIONAR VENDA ‚îÄ‚îÄ
  window.addSale = async function() {
    const cliente    = document.getElementById('fCliente').value.trim();
    const clienteId  = document.getElementById('fClienteId').value.trim().toLowerCase();
    const produto    = document.getElementById('fProduto').value.trim();
    const valor      = parseFloat(document.getElementById('fValor').value);
    const vencimento = document.getElementById('fVencimento').value;
    const situacao   = document.getElementById('fSituacao').value;

    if (!cliente || !clienteId || !produto || isNaN(valor) || !vencimento) {
      showToast('Preencha todos os campos.', 'error'); return;
    }

    setLoading('btnAdd', true, '‚úî Registrar Venda');

    try {
      await addDoc(collection(db, 'vendas'), {
        cliente, clienteId, produto, valor, vencimento, situacao,
        createdAt: new Date().toISOString()
      });
      showToast('Venda registrada com sucesso!');
      ['fCliente','fClienteId','fProduto','fValor','fVencimento'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('fSituacao').value = 'pendente';
    } catch (e) {
      showToast('Erro ao salvar. Tente novamente.', 'error');
    }

    setLoading('btnAdd', false, '‚úî Registrar Venda');
  };

  // ‚îÄ‚îÄ RENDERIZAR TABELA ADMIN ‚îÄ‚îÄ
  window.renderTable = function() {
    const search = (document.getElementById('filterSearch')?.value || '').toLowerCase();
    const status =  document.getElementById('filterStatus')?.value || '';

    let filtered = sales.filter(s => {
      const matchSearch = s.cliente.toLowerCase().includes(search) ||
                          s.produto.toLowerCase().includes(search) ||
                          s.clienteId.toLowerCase().includes(search);
      const matchStatus = !status || s.situacao === status;
      return matchSearch && matchStatus;
    });

    const tbody = document.getElementById('salesTableBody');
    if (filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state">Nenhuma venda encontrada.</div></td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map((s, i) => `
      <tr>
        <td>${i + 1}</td>
        <td>
          <strong style="color:#f1f5f9">${s.cliente}</strong><br>
          <small style="color:#64748b">${s.clienteId}</small>
        </td>
        <td>${s.produto}</td>
        <td style="color:#4ade80; font-weight:600">${fmt(s.valor)}</td>
        <td>${fmtDate(s.vencimento)}</td>
        <td>${badgeHTML(s.situacao)}</td>
        <td>
          <button class="btn-action btn-edit" onclick="openEdit('${s.docId}')">Editar</button>
          <button class="btn-action btn-delete" onclick="deleteSale('${s.docId}')">Excluir</button>
        </td>
      </tr>
    `).join('');
  };

  // ‚îÄ‚îÄ CARDS ADMIN ‚îÄ‚îÄ
  function renderAdminCards() {
    const total    = sales.length;
    const pago     = sales.filter(s => s.situacao === 'pago').reduce((a, s) => a + s.valor, 0);
    const pendente = sales.filter(s => s.situacao === 'pendente').reduce((a, s) => a + s.valor, 0);
    const vencido  = sales.filter(s => s.situacao === 'vencido').reduce((a, s) => a + s.valor, 0);

    document.getElementById('adminCards').innerHTML = `
      <div class="card blue"><div class="label">Total de Vendas</div><div class="value">${total}</div></div>
      <div class="card green"><div class="label">Recebido</div><div class="value">${fmt(pago)}</div></div>
      <div class="card yellow"><div class="label">A Receber</div><div class="value">${fmt(pendente)}</div></div>
      <div class="card red"><div class="label">Vencido</div><div class="value">${fmt(vencido)}</div></div>
    `;
  }

  // ‚îÄ‚îÄ EXCLUIR ‚îÄ‚îÄ
  window.deleteSale = async function(docId) {
    if (!confirm('Deseja excluir esta venda?')) return;
    try {
      await deleteDoc(doc(db, 'vendas', docId));
      showToast('Venda exclu√≠da.');
    } catch (e) {
      showToast('Erro ao excluir.', 'error');
    }
  };

  // ‚îÄ‚îÄ EDITAR ‚îÄ‚îÄ
  window.openEdit = function(docId) {
    const s = sales.find(s => s.docId === docId);
    if (!s) return;
    document.getElementById('editDocId').value      = s.docId;
    document.getElementById('editCliente').value    = s.cliente;
    document.getElementById('editClienteId').value  = s.clienteId;
    document.getElementById('editProduto').value    = s.produto;
    document.getElementById('editValor').value      = s.valor;
    document.getElementById('editVencimento').value = s.vencimento;
    document.getElementById('editSituacao').value   = s.situacao;
    document.getElementById('editModal').classList.add('open');
  };

  window.closeModal = function() {
    document.getElementById('editModal').classList.remove('open');
  };

  window.saveEdit = async function() {
    const docId = document.getElementById('editDocId').value;
    setLoading('btnSaveEdit', true, 'Salvar Altera√ß√µes');

    try {
      await updateDoc(doc(db, 'vendas', docId), {
        cliente:    document.getElementById('editCliente').value.trim(),
        clienteId:  document.getElementById('editClienteId').value.trim().toLowerCase(),
        produto:    document.getElementById('editProduto').value.trim(),
        valor:      parseFloat(document.getElementById('editValor').value),
        vencimento: document.getElementById('editVencimento').value,
        situacao:   document.getElementById('editSituacao').value,
      });
      showToast('Venda atualizada!');
      closeModal();
    } catch (e) {
      showToast('Erro ao atualizar.', 'error');
    }

    setLoading('btnSaveEdit', false, 'Salvar Altera√ß√µes');
  };

  // ‚îÄ‚îÄ PAINEL CLIENTE ‚îÄ‚îÄ
  function renderClientPanel(mySales) {
    const sorted   = [...mySales].sort((a, b) => a.vencimento.localeCompare(b.vencimento));
    const totalGasto = mySales.reduce((a, s) => a + s.valor, 0);
    const aPagar   = mySales.filter(s => s.situacao === 'pendente' || s.situacao === 'vencido').reduce((a, s) => a + s.valor, 0);
    const pago     = mySales.filter(s => s.situacao === 'pago').reduce((a, s) => a + s.valor, 0);

    document.getElementById('clientCards').innerHTML = `
      <div class="card blue"><div class="label">Total de Compras</div><div class="value">${mySales.length}</div></div>
      <div class="card green"><div class="label">Total Pago</div><div class="value">${fmt(pago)}</div></div>
      <div class="card yellow"><div class="label">A Pagar</div><div class="value">${fmt(aPagar)}</div></div>
      <div class="card blue"><div class="label">Total Geral</div><div class="value">${fmt(totalGasto)}</div></div>
    `;

    const tbody = document.getElementById('clientTableBody');
    if (sorted.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">Nenhuma compra encontrada.</div></td></tr>`;
      return;
    }

    tbody.innerHTML = sorted.map((s, i) => `
      <tr>
        <td>${i + 1}</td>
        <td>${s.produto}</td>
        <td style="color:#4ade80; font-weight:600">${fmt(s.valor)}</td>
        <td>${fmtDate(s.vencimento)}</td>
        <td>${badgeHTML(s.situacao)}</td>
      </tr>
    `).join('');
  }

  // ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
  window.logout = function() {
    if (unsubscribe) { unsubscribe(); unsubscribe = null; }
    currentClientId = null;
    sales = [];
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('adminPanel').style.display  = 'none';
    document.getElementById('clientPanel').style.display = 'none';
    document.getElementById('adminUser').value  = '';
    document.getElementById('adminPass').value  = '';
    document.getElementById('clientId').value   = '';
    document.getElementById('adminError').textContent  = '';
    document.getElementById('clientError').textContent = '';
  };

  // ‚îÄ‚îÄ FECHAR MODAL CLICANDO FORA ‚îÄ‚îÄ
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  // ‚îÄ‚îÄ ENTER NO LOGIN ‚îÄ‚îÄ
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      if (currentTab === 'admin') window.loginAdmin();
      else window.loginClient();
    }
  });
</script>
</body>
</html>
